create or replace function amazon_s3_fdw.generate_tu_tables(--p_partition_num integer,
p_num_files integer)
returns integer
as
$BODY$
declare v_ddl text;
i integer;
v_num integer :=0;
v_partition_name text:='tu';
begin
for i in 0..p_num_files-1 loop
v_ddl:=format($create_ft$
drop foreign table if exists amazon_s3_fdw.%s_%s_csv cascade;
create foreign table amazon_s3_fdw.%s_%s_csv(
    state_code text,
    trv01 text,
    cv15 text,
    cv16 text,
    bc21s text,
    g100s text,
    g230s text,
    of24s text,
    s114s text,
    ssub01_score text,
    scrat01 text,
    scrat07 text,
    scrat09 text,
    scrat27 text,
    scrat29 text,
    scrbr28 text,
    scrre03 text,
    scrre28 text,
    scrfi01 text,
    scrmt01 text,
    scrbc01 text,
    scrbc21 text,
    scrg001 text,
    scrg024 text,
    scrg048 text,
    scrg096 text,
    scrg098 text,
    scrs004 text,
    scrs059 text,
    rmdspflg text,
    age text,
    infrage text,
    colxmd24 text,
    colbalth text,
    trdcl6 text,
    fiopenth text,
    firatio text,
    numsattr text,
    revaggcr text,
    bkrnage text,
    bknage text,
    bkopbl12 text,
    bktrades text,
    bkagblth text,
    bkagbal text,
    bankmof text,
    hmp4gn6 text,
    h2in24af text,
    numinq12 text,
    inqnoa text,
    colbl36h text,
    bkavgcl text,
    finscore text,
    br31 text,
    re30 text,
    fi28 text,
    fi35 text,
    pf28 text,
    pf32 text,
    bc27 text,
    rt25 text,
    ds20 text,
    fn01 text,
    fn20 text,
    bk20 text,
    bk28 text,
    bk33 text,
    bk35 text,
    cvtg2a_score text,
    sbau2a_score text,
    rtl_trd text,
    trv08 text,
    trv10 text,
    cv21 text,
    at20s text,
    trau_cv text,
    scrg051 text,
    trdsat text,
    permid text,
    scrg103 text,
    sbaut5_score text,
    cna201_score text,
    eads19_score text,
    eads20_score text,
    eads23_score text,
    sbaut3_score text,
    sbaut6_score text,
    sbaut2_score text,
    etie04_score text,
    die text,
    tie3 text,
    agg910 text,
    bc107s text,
    g199s text,
    g207s text,
    of09s text,
    of101s text,
    scrs064 text,
    autoutil text,
    fi36 text,
    scrs115 text,
    fiopenmo text,
    bc102s text,
    fi24s text,
    g208s text,
    g212s text,
    g304s text,
    re28s text,
    revs903 text) SERVER amazon_s3
    OPTIONS (
  hostname 's3-us-east-1.amazonaws.com',
  bucketname 'balancedata',
  filename 'DmDrops/marketing/%s_%s.csv',
  format 'csv',
  delimiter E',',
  quote E'"',
  header 'false'
);
    
alter table amazon_s3_fdw.%s_%s_csv owner to dw_owner;
grant select on amazon_s3_fdw.%s_%s_csv to dw_proxy_load;
drop view if exists amazon_s3_fdw._%s_%s;
create or replace view amazon_s3_fdw._%s_%s as
select 
    state_code,
    (case when trv01 ='' then NULL else trv01 end )::numeric  as trv01 ,
    (case when cv15  ='' then NULL else cv15  end )::numeric  as cv15  ,
    (case when cv16  ='' then NULL else cv16  end )::numeric  as cv16  ,
    (case when bc21s ='' then NULL else bc21s end )::numeric  as bc21s , 
    (case when g230s ='' then NULL else g230s end ):: numeric as g230s ,
    (case when of24s ='' then NULL else of24s end ):: numeric as of24s ,
    (case when s114s ='' then NULL else s114s  end   ):: numeric as s114s ,
    (case when at20s ='' then NULL else at20s end   ):: numeric as at20s ,
    (case when ssub01_score ='' then NULL else ssub01_score  end    )::numeric as ssub01_score ,
    scrat01,
    (case when scrat07     ='' then NULL else scrat07      end)::numeric  as scrat07     ,
    (case when scrg024     ='' then NULL else scrg024      end)::numeric  as scrg024     ,
    rmdspflg  ,                                                           
    (case when age         ='' then NULL else age          end)::numeric  as age          ,
    (case when infrage     ='' then NULL else infrage      end)::numeric  as infrage      ,
    (case when trdcl6      ='' then NULL else trdcl6       end)::numeric  as trdcl6       ,
    (case when fiopenth    ='' then NULL else fiopenth     end)::numeric  as fiopenth     ,
    (case when firatio     ='' then NULL else firatio      end)::numeric  as firatio      ,
    (case when bkrnage     ='' then NULL else bkrnage      end)::numeric  as bkrnage      ,
    (case when hmp4gn6     ='' then NULL else hmp4gn6      end)::numeric  as hmp4gn6      ,
    (case when h2in24af    ='' then NULL else h2in24af     end)::numeric  as h2in24af     ,
    (case when finscore    ='' then NULL else finscore     end)::numeric  as finscore     ,
    (case when fi35        ='' then NULL else fi35         end):: numeric as fi35         ,
    (case when fn20        ='' then NULL else fn20         end):: numeric as fn20         ,
    (case when cvtg2a_score='' then NULL else cvtg2a_score end):: numeric as cvtg2a_score ,
    (case when rtl_trd     ='' then NULL else rtl_trd      end):: numeric as rtl_trd      ,
    (case when trv08       ='' then NULL else trv08        end):: numeric as trv08       ,
    (case when trv10       ='' then NULL else trv10        end):: numeric as trv10       ,
    (case when cv21        ='' then NULL else cv21         end):: numeric as cv21         ,
    (case when trau_cv     ='' then NULL else trau_cv      end):: numeric as trau_cv      ,
    (case when scrg051     ='' then NULL else scrg051      end):: numeric as scrg051      ,
    (case when trdsat      ='' then NULL else trdsat       end):: numeric as trdsat       ,
   permid ,
    (case when scrg103     ='' then NULL else scrg103      end):: numeric as scrg103      ,
    (case when eads23_score='' then NULL else eads23_score end):: numeric as eads23_score ,
    (case when etie04_score='' then NULL else etie04_score end):: numeric as etie04_score ,
    (case when agg910      ='' then NULL else agg910       end):: numeric as agg910        ,
    (case when bc107s      ='' then NULL else bc107s       end):: numeric as bc107s        ,
    (case when g199s       ='' then NULL else g199s        end):: numeric as g199s         ,
    (case when g207s       ='' then NULL else g207s        end):: numeric as g207s         ,
    (case when of09s       ='' then NULL else of09s        end):: numeric as of09s         ,
    (case when of101s      ='' then NULL else of101s       end):: numeric as of101s       ,
    (case when scrs064     ='' then NULL else scrs064      end):: numeric as scrs064      ,
    (case when autoutil    ='' then NULL else autoutil     end):: numeric as autoutil     ,
    (case when fi36        ='' then NULL else fi36         end):: numeric as fi36         ,
    (case when scrs115     ='' then NULL else scrs115      end):: numeric as scrs115      ,
    (case when fiopenmo    ='' then NULL else fiopenmo     end):: numeric as fiopenmo     ,
    (case when bc102s      ='' then NULL else bc102s       end):: numeric as bc102s       ,
    (case when fi24s       ='' then NULL else fi24s        end):: numeric as fi24s        ,
    (case when g208s       ='' then NULL else g208s        end):: numeric as g208s        ,
    (case when g212s       ='' then NULL else g212s        end):: numeric as g212s        ,
    (case when g304s       ='' then NULL else g304s        end):: numeric as g304s        ,
    (case when re28s       ='' then NULL else re28s        end):: numeric as re28s        ,
    (case when revs903     ='' then NULL else revs903      end):: numeric as revs903      ,
    -- added additional columns for new income model
    (case when fi28 = '' then null else fi28 end)::numeric as fi28,
    (case when die = '' then null else die end)::numeric as die,
    (case when pf32 = '' then null else pf32 end)::numeric as pf32,
    (case when revaggcr = '' then null else revaggcr end)::numeric as revaggcr,
    (case when bktrades = '' then null else bktrades end)::numeric as bktrades,
    (case when tie3 = '' then null else tie3 end)::numeric as tie3,
    -- new columns for funding rate model
    nullif(scrg096, '')::numeric as scrg096,
    nullif(scrfi01, '')::numeric as scrfi01,
    nullif(sbaut3_score, '')::numeric as sbaut3_score,
    -- new columns for auxiliary response models
    nullif(eads19_score, '')::numeric as eads19_score,
    nullif(cna201_score, '')::numeric as cna201_score,
    nullif(sbaut5_score, '')::numeric as sbaut5_score,
    nullif(sbaut6_score, '')::numeric as sbaut6_score,
    nullif(eads20_score, '')::numeric as eads20_score
from amazon_s3_fdw.%s_%s_csv;
    alter view amazon_s3_fdw._%s_%s owner to dw_owner;
    grant select on amazon_s3_fdw._%s_%s to dw_proxy_load;
    $create_ft$,
    v_partition_name,
    i,
    v_partition_name,    
    i,
    v_partition_name, 
    i,
    v_partition_name, 
    i,
    v_partition_name, 
    i,
    v_partition_name, 
    i,
    v_partition_name, 
    i,
    v_partition_name, 
    i,
    v_partition_name, 
    i,
    v_partition_name, 
    i);
    --raise notice 'text %',v_ddl;
    execute v_ddl;
    v_num:=v_num+1;
    end loop;
    return v_num;
    end;
    $BODY$
    language plpgsql;
    
alter function amazon_s3_fdw.generate_tu_tables(int) owner to dw_owner;
